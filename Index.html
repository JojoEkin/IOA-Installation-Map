<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="appTitle">全国装机地图</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        #main-content {
            flex-grow: 1;
            display: flex;
            overflow: hidden;
        }
        #map-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: #000;
            padding: 1rem;
            position: relative;
        }
        #map {
            flex-grow: 1;
            background-color: #000;
        }
        #sidebar {
            width: 300px;
            background-color: #000;
            color: white;
            padding: 2rem;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .filter-button {
            background-color: #4a5568;
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }
        .filter-button:hover {
            background-color: #718096;
            transform: scale(1.02);
        }
        .filter-button.active {
            background-color: #4299e1;
            box-shadow: 0 0 10px #4299e1;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #2d3748;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            color: white;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .close-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
        }
        .input-group {
            margin-bottom: 1rem;
        }
        .transparent-label {
            background-color: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }
        #edit-controls {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 999;
        }
        #edit-controls button {
            margin-left: 0.5rem;
        }
        .filter-button img {
            max-width: 100%;
            height: auto;
            max-height: 50px;
            margin-bottom: 0.5rem;
        }
        .message-modal {
            background-color: #2d3748;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            max-width: 400px;
            text-align: center;
            color: white;
        }
        /* New styles for edit mode */
        .edit-mode-active .filter-button:not(#all-instruments-btn) {
            border: 2px solid #f9a8d4;
            box-shadow: 0 0 10px #f9a8d4;
            transform: scale(1.02);
        }
        .edit-mode-active .filter-button.active {
            background-color: #4a5568; /* Deactivate blue color in edit mode */
            box-shadow: none;
        }

        /* Collapsible controls styling */
        #collapsible-controls {
            max-height: 200px; /* Adjust based on content */
            overflow-y: auto;
            overflow-x: hidden;
            transition: max-height 0.3s ease-in-out;
            scrollbar-width: thin;
            scrollbar-color: #4a5568 #2d3748;
        }
        #collapsible-controls.collapsed {
            max-height: 0;
        }
        #toggle-icon.rotated {
            transform: rotate(45deg);
        }
        #instrument-details-container {
            width: 100%;
            max-height: 14rem;
            overflow-y: auto;
            padding: 1rem;
            background-color: #1a202c;
            color: white;
            border-top: 1px solid #4a5568;
        }
        .details-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        .details-table th, .details-table td {
            border: 1px solid #4a5568;
            padding: 0.75rem;
            text-align: left;
        }
        .details-table th {
            background-color: #2d3748;
            font-weight: bold;
        }
        #dashboard-chart-container {
            height: 200px;
            width: 100%;
        }
        .leaflet-container .leaflet-control-attribution {
            display: none;
        }
        .tech-button {
            position: relative;
            background: linear-gradient(145deg, #1f2937, #111827);
            border: 1px solid #374151;
            color: #d1d5db;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 12px;
            font-weight: bold;
            text-shadow: 1px 1px 2px #000;
            box-shadow: 5px 5px 10px #0a0e14, -5px -5px 10px #242c38;
            transition: all 0.2s ease;
        }
        .tech-button:hover {
            transform: translateY(-2px);
            box-shadow: 8px 8px 15px #0a0e14, -8px -8px 15px #242c38;
            color: #fff;
        }
        .tech-button:active {
            transform: translateY(1px);
            box-shadow: inset 3px 3px 5px #0a0e14, inset -3px -3px 5px #242c38;
        }
        .map-style {
            fill: #0077b6;
            stroke: #fff;
            stroke-width: 1;
            fill-opacity: 0.7;
            transition: fill-opacity 0.3s;
            filter: drop-shadow(0 0 5px rgba(0, 119, 182, 0.5));
            -webkit-filter: drop-shadow(0 0 5px rgba(0, 119, 182, 0.5));
            transform-origin: center center;
            transform: rotateX(15deg) translateZ(0);
        }
        .map-glow {
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0% { box-shadow: 0 0 10px #4299e1, 0 0 20px #4299e1; }
            50% { box-shadow: 0 0 15px #4299e1, 0 0 30px #4299e1; }
            100% { box-shadow: 0 0 10px #4299e1, 0 0 20px #4299e1; }
        }
        
    </style>
</head>
<body>

<div id="main-content">
    <div id="sidebar">
        <div class="flex flex-col items-center">
            <img id="logo-display" src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChAKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAEBAQICASIAAhEBAQED/8QAHwAAAQUBAQEBAQEBAAAAAAAAAAECAwQFBgcICQoLAQACAgMVBQEBAQEBAAAAAAAAAAECAwQFBgcICQoLEAAB" alt="Logo" class="w-24 h-24 mb-4 cursor-pointer">
            <div id="collapsible-controls" class="space-y-2 collapsed">
                <button id="data-upload-btn" class="w-full tech-button mb-2" data-i18n="dataUploadButton">
                    装机数据上传
                </button>
                <button id="edit-mode-btn" class="w-full tech-button mb-2" data-i18n="mapEdit">
                    地图编辑
                </button>
                <button id="add-instrument-btn" class="w-full tech-button mb-2" data-i18n="addInstrumentType">
                    新增仪器类型
                </button>
                <button id="edit-instrument-types-btn" class="w-full tech-button mb-2" data-i18n="editInstrumentTypes">
                    编辑仪器类型
                </button>
                <button id="map-admin-btn" class="w-full tech-button mb-2" data-i18n="mapAdminButton">
                    地图管理
                </button>
                <button id="export-standalone-btn" class="w-full tech-button" data-i18n="exportStandalone">
                    发布单机页面
                </button>
            </div>
        </div>
        <div class="flex items-center justify-center mb-4 space-x-2">
            <button id="lang-zh-btn" class="tech-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-lg">中文</button>
            <button id="lang-en-btn" class="tech-button bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded-lg">EN</button>
        </div>
        <div class="flex flex-col space-y-2 mb-4">
            <div>
                <label for="year-filter" class="block text-sm font-medium text-gray-400" data-i18n="selectYear">选择年份</label>
                <select id="year-filter" class="w-full mt-1 px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white"></select>
            </div>
            <div>
                <label for="month-filter" class="block text-sm font-medium text-gray-400" data-i18n="selectMonth">选择月份</label>
                <select id="month-filter" class="w-full mt-1 px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white"></select>
            </div>
        </div>
        <div id="filter-buttons-container" class="flex flex-col space-y-2">
            <button id="all-instruments-btn" class="filter-button active" data-name="all" data-i18n="allInstruments">所有仪器</button>
        </div>

        <div class="mt-auto pt-6">
            
        </div>
    </div>

    <div id="map-container">
        <div class="bg-gray-800 text-white text-center p-4 rounded-lg mb-4" style="background-color: transparent;">
            <h1 class="text-3xl font-bold" data-i18n="mapTitle">IOA仪器中国装机地图</h1>
            <p class="text-sm mt-1" id="total-count-display" data-i18n="totalCount">全国装机数量: 0</p>
            <p class="text-xs mt-1 text-gray-400" id="last-updated-display" data-i18n="lastUpdated">数据未更新</p>
        </div>
        <div id="map" class="rounded-lg"></div>
    </div>
</div>

<div id="instrument-details-container" class="mt-4 p-4 text-white">
    <div class="flex justify-between items-center mb-2">
        <h2 class="text-xl font-bold" id="details-view-title" data-i18n="detailsTitle">仪器明细</h2>
        <button id="view-toggle-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded-full text-sm transition-colors">
            <span data-i18n="dashboardBtn">仪表盘</span>
        </button>
    </div>
    <div id="details-view-content">
        <div id="details-table-content" class="bg-gray-800 rounded-lg p-4">
            <span data-i18n="detailsPlaceholder">请在地图上点击一个省份来查看装机明细。</span>
        </div>
        <div id="dashboard-content" class="bg-gray-800 rounded-lg p-4 hidden">
            <div id="dashboard-chart-container" class="w-full h-80"></div>
        </div>
    </div>
</div>

<div id="edit-controls" class="hidden">
    <button id="save-edit-btn" class="tech-button bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full" data-i18n="save">
        保存
    </button>
    <button id="cancel-edit-btn" class="tech-button bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full" data-i18n="cancel">
        取消
    </button>
</div>

<div id="map-admin-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="text-lg font-bold" data-i18n="mapAdminTitle">地图管理</h3>
            <span class="close-button" id="map-admin-close-btn">&times;</span>
        </div>
        <div class="input-group">
            <label for="geojson-upload" class="block text-sm font-medium mb-1" data-i18n="uploadGeojsonData">上传地理数据文件 (.geojson)</label>
            <input type="file" id="geojson-upload" accept=".geojson" class="w-full text-white">
        </div>
        <div class="input-group">
            <label for="logo-upload" class="block text-sm font-medium mb-1" data-i18n="uploadLogo">上传Logo图片 (.png, .jpg, .jpeg)</label>
            <input type="file" id="logo-upload" accept=".png, .jpg, .jpeg" class="w-full text-white">
        </div>
        <div class="flex flex-col space-y-2 mt-4">
            <button id="save-map-admin-btn" class="w-full tech-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full" data-i18n="save">
                保存
            </button>
        </div>
    </div>
</div>

<div id="data-upload-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="text-lg font-bold" data-i18n="dataUploadTitle">装机数据上传</h3>
            <span class="close-button" id="data-upload-close-btn">&times;</span>
        </div>
        <div class="input-group">
            <label for="data-upload" class="block text-sm font-medium mb-1" data-i18n="uploadDataFile">上传数据文件 (.csv)</label>
            <input type="file" id="data-upload" accept=".csv" class="w-full text-white">
        </div>
        <div class="flex flex-col space-y-2 mt-4">
            <button id="save-data-upload-btn" class="w-full tech-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full" data-i18n="save">
                保存
            </button>
        </div>
    </div>
</div>

<div id="add-instrument-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="text-lg font-bold" id="instrument-modal-title" data-i18n="addInstrumentTitle">新增仪器类型</h3>
            <span class="close-button" id="add-instrument-close-btn">&times;</span>
        </div>
        <div class="input-group">
            <label for="instrument-name" class="block text-sm font-medium mb-1" data-i18n="instrumentTypeName">仪器类型名称</label>
            <input type="text" id="instrument-name" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white" placeholder="请输入仪器类型名称">
        </div>
        <div class="input-group">
            <label for="keywords" class="block text-sm font-medium mb-1" data-i18n="keywordsLabel">关键词 (多个用逗号分隔)</label>
            <input type="text" id="keywords" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white" placeholder="例如: 关键词1,关键词2">
        </div>
        <div class="input-group">
            <label for="image-upload" class="block text-sm font-medium mb-1" data-i18n="uploadImage">上传图片 (.png, .jpg, .jpeg)</label>
            <input type="file" id="image-upload" accept=".png, .jpg, .jpeg" class="w-full text-white">
        </div>
        <div class="flex justify-between mt-4">
            <button id="save-add-btn" class="w-1/2 tech-button bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full mr-2" data-i18n="save">
                保存
            </button>
            <button id="delete-instrument-btn" class="w-1/2 tech-button bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full ml-2 hidden" data-i18n="delete">
                删除
            </button>
        </div>
    </div>
</div>

<div id="password-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="text-lg font-bold" data-i18n="passwordPromptTitle">输入密码</h3>
            <span class="close-button" id="password-close-btn">&times;</span>
        </div>
        <div class="input-group">
            <label for="password-input" class="block text-sm font-medium mb-1" data-i18n="passwordLabel">请输入密码</label>
            <input type="password" id="password-input" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white" placeholder="******">
        </div>
        <button id="password-submit-btn" class="w-full tech-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full mt-4" data-i18n="confirm">
            确认
        </button>
    </div>
</div>

<div id="message-modal" class="modal">
    <div class="message-modal rounded-lg p-6">
        <p id="message-text"></p>
    </div>
</div>

<script>
    (function() {
        // ------------------ 更改：移除 IndexedDB 相关配置 ------------------
        // const DB_NAME = 'ioaInstrumentDB';
        // const DB_VERSION = 1;
        // let db;
        
        const ADMIN_PASSWORD = '12345678';
        const DATA_FILES = {
            definitions: 'instrumentDefinitions.json',
            offsets: 'savedLabelOffsets.json',
            logo: 'logoImage.json',
            data: 'allData.json',
            geojson: 'geojsonData.json',
            updated: 'lastUpdated.json'
        };
        
        let isControlsUnlocked = false;
        let lang = 'zh';

        const translations = {
            zh: {
                appTitle: '全国装机地图',
                selectYear: '选择年份',
                selectMonth: '选择月份',
                allInstruments: '所有仪器',
                controlPanel: '控制面板',
                mapEdit: '地图编辑',
                addInstrumentType: '新增仪器类型',
                editInstrumentTypes: '编辑仪器类型',
                mapAdminButton: '地图管理',
                dataUploadButton: '装机数据上传',
                dashboardBtn: '仪表盘',
                detailsBtn: '明细',
                exportStandalone: '发布单机页面',
                mapTitle: 'IOA仪器中国装机地图',
                totalCount: (count) => `全国装机数量: ${count}`,
                lastUpdated: (date) => date ? `数据更新时间: ${new Date(date).toLocaleString()}` : '数据未更新',
                detailsTitle: '仪器明细',
                detailsPlaceholder: '请在地图上点击一个省份来查看装机明细。',
                detailsTableTitle: (name, count) => `明细: ${name} (${count} 台)`,
                tableHeaderDate: '日期',
                tableHeaderHospital: '医院',
                tableHeaderProduct: '产品信息',
                tableHeaderInstallInfo: '安装信息',
                save: '保存',
                cancel: '取消',
                mapAdminTitle: '地图管理',
                dataUploadTitle: '装机数据上传',
                uploadDataFile: '上传数据文件 (.csv)',
                uploadGeojsonData: '上传地理数据文件 (.geojson)',
                uploadLogo: '上传Logo图片 (.png, .jpg, .jpeg)',
                addInstrumentTitle: '新增仪器类型',
                instrumentTypeName: '仪器类型名称',
                keywordsLabel: '关键词 (多个用逗号分隔)',
                uploadImage: '上传图片 (.png, .jpg, .jpeg)',
                delete: '删除',
                passwordPromptTitle: '输入密码',
                passwordLabel: '请输入密码',
                confirm: '确认',
                messageFileFailed: '文件读取失败。',
                messageGeojsonSuccess: 'GeoJSON 文件上传成功！(请将生成的 geojsonData.json 上传到服务器)',
                messageGeojsonError: '解析 GeoJSON 文件失败，请检查文件格式。',
                messageCsvMissingCols: (cols) => `CSV 文件缺少必需的列: ${cols}。请检查文件头部。`,
                messageCsvSuccess: '数据文件上传成功！(请将生成的 allData.json 和 lastUpdated.json 上传到服务器)',
                messageCsvError: '解析 CSV 文件失败，请检查文件格式。',
                messageLogoError: '上传Logo图片失败。',
                messageFileRequired: '请至少选择一个文件进行上传。',
                messagePasswordCorrect: '密码正确！',
                messagePasswordError: '密码错误，请重试。',
                messageUnlockRequired: '请先解锁控制面板以访问此功能。',
                messageAllInstrumentsImmutable: '“所有仪器”按钮不可编辑。',
                messageInstrumentUpdated: '仪器类型已更新！(请将生成的 instrumentDefinitions.json 上传到服务器)',
                messageInstrumentAdded: '新增仪器类型已保存！(请将生成的 instrumentDefinitions.json 上传到服务器)',
                messageInstrumentDeleted: '仪器类型已删除！(请将生成的 instrumentDefinitions.json 上传到服务器)',
                messageSaveLocationSuccess: '位置已保存！(请将生成的 savedLabelOffsets.json 上传到服务器)',
                messageUploadDataFirst: '请先上传 GeoJSON 和 CSV 数据文件。',
                messageNameKeywordsRequired: '请填写仪器类型名称和至少一个关键词。',
                noDataMessage: '当前筛选条件下没有数据',
                selectYearPrompt: '请选择具体的年份',
                dashboardTitle: '安装数量仪表盘',
                exportSuccess: '单机页面已生成并下载！'
            },
            en: {
                appTitle: 'IOA Installed Base Map',
                selectYear: 'Select Year',
                selectMonth: 'Select Month',
                allInstruments: 'All Instruments',
                controlPanel: 'Control Panel',
                mapEdit: 'Map Edit',
                addInstrumentType: 'Add Instrument Type',
                editInstrumentTypes: 'Edit Instrument Types',
                mapAdminButton: 'Map Management',
                dataUploadButton: 'Data Upload',
                dashboardBtn: 'Dashboard',
                detailsBtn: 'Details',
                exportStandalone: 'Export Standalone Page',
                mapTitle: 'IOA Instrument Installation Map',
                totalCount: (count) => `Total Installed Count: ${count}`,
                lastUpdated: (date) => date ? `Last Updated: ${new Date(date).toLocaleString()}` : 'Data not updated',
                detailsTitle: 'Instrument Details',
                detailsPlaceholder: 'Click a province on the map to view installation details.',
                detailsTableTitle: (name, count) => `Details: ${name} (${count} units)`,
                tableHeaderDate: 'Date',
                tableHeaderHospital: 'Hospital',
                tableHeaderProduct: 'Product Info',
                tableHeaderInstallInfo: 'Install Info',
                save: 'Save',
                cancel: 'Cancel',
                mapAdminTitle: 'Map Management',
                dataUploadTitle: 'Data Upload',
                uploadDataFile: 'Upload Data File (.csv)',
                uploadGeojsonData: 'Upload GeoJSON File (.geojson)',
                uploadLogo: 'Upload Logo Image (.png, .jpg, .jpeg)',
                addInstrumentTitle: 'Add Instrument Type',
                instrumentTypeName: 'Instrument Type Name',
                keywordsLabel: 'Keywords (comma-separated)',
                uploadImage: 'Upload Image (.png, .jpg, .jpeg)',
                delete: 'Delete',
                passwordPromptTitle: 'Enter Password',
                passwordLabel: 'Enter Password',
                confirm: 'Confirm',
                messageFileFailed: 'File read failed.',
                messageGeojsonSuccess: 'GeoJSON file uploaded successfully! (Please upload the generated geojsonData.json to the server)',
                messageGeojsonError: 'Failed to parse GeoJSON file. Please check file format.',
                messageCsvMissingCols: (cols) => `CSV file is missing required columns: ${cols}. Please check file header.`,
                messageCsvSuccess: 'Data file uploaded successfully! (Please upload the generated allData.json and lastUpdated.json to the server)',
                messageCsvError: 'Failed to parse CSV file. Please check file format.',
                messageLogoError: 'Failed to upload logo image.',
                messageFileRequired: 'Please select at least one file to upload.',
                messagePasswordCorrect: 'Password is correct!',
                messagePasswordError: 'Incorrect password, please try again.',
                messageUnlockRequired: 'Please unlock the control panel to access this feature.',
                messageAllInstrumentsImmutable: '"All Instruments" button cannot be edited.',
                messageInstrumentUpdated: 'Instrument type updated successfully! (Please upload the generated instrumentDefinitions.json to the server)',
                messageInstrumentAdded: 'New instrument type saved successfully! (Please upload the generated instrumentDefinitions.json to the server)',
                messageInstrumentDeleted: 'Instrument type deleted! (Please upload the generated instrumentDefinitions.json to the server)',
                messageSaveLocationSuccess: 'Locations saved! (Please upload the generated savedLabelOffsets.json to the server)',
                messageUploadDataFirst: 'Please upload GeoJSON and CSV data files first.',
                messageNameKeywordsRequired: 'Please fill in the instrument type name and at least one keyword.',
                noDataMessage: 'No data under current filter conditions',
                selectYearPrompt: 'Please select a specific year',
                dashboardTitle: 'Installation Dashboard',
                exportSuccess: 'Standalone page generated and downloaded!'
            }
        };

        // --- Static configurations and global state ---
        let map, geojsonLayer, markerGroup, currentDraggedOffsets = {};
        // 更改：默认 Logo 图像使用原始的 base64 字符串
        const DEFAULT_LOGO_IMAGE = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChAKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAEBAQICASIAAhEBAQED/8QAHwAAAQUBAQEBAQEBAAAAAAAAAAECAwQFBgcICQoLAQACAgMVBQEBAQEBAAAAAAAAAAECAwQFBgcICQoLEAAB';
        let state = {
            instrumentDefinitions: [],
            savedLabelOffsets: {},
            logoImage: DEFAULT_LOGO_IMAGE,
            allData: [],
            geojsonData: null,
            lastUpdated: null,
            isDashboardVisible: false
        };
        const expectedDataColumns = ['日期时间', '省份拼音', '产品信息', '医院', '安装信息'];
        let isInstrumentEditingMode = false;
        let selectedProvincePinyin = null;

        // Default label offsets
        const defaultLabelOffsets = {
            'gansu': [38.5, 103], 'neimenggu': [44.5, 110], 'shaanxi': [35.5, 109.5],
            'taiwan': [23.8, 121], 'hainan': [19.2, 109.8], 'hongkong': [22.25, 114.16],
            'macau': [22.19, 113.54]
        };

        // --- DOM element references (保持不变) ---
        const mapAdminModal = document.getElementById('map-admin-modal');
        const mapAdminBtn = document.getElementById('map-admin-btn');
        const mapAdminCloseBtn = document.getElementById('map-admin-close-btn');
        const saveMapAdminBtn = document.getElementById('save-map-admin-btn');
        const dataUploadBtn = document.getElementById('data-upload-btn');
        const dataUploadModal = document.getElementById('data-upload-modal');
        const dataUploadCloseBtn = document.getElementById('data-upload-close-btn');
        const saveMapDataBtn = document.getElementById('save-data-upload-btn');
        const dataUploadInput = document.getElementById('data-upload');
        const geojsonUploadInput = document.getElementById('geojson-upload');
        const logoUploadInput = document.getElementById('logo-upload');
        
        const addInstrumentModal = document.getElementById('add-instrument-modal');
        const addInstrumentBtn = document.getElementById('add-instrument-btn');
        const addInstrumentCloseBtn = document.getElementById('add-instrument-close-btn');
        const saveAddBtn = document.getElementById('save-add-btn');
        const deleteInstrumentBtn = document.getElementById('delete-instrument-btn');
        const instrumentModalTitle = document.getElementById('instrument-modal-title');
        const instrumentNameInput = document.getElementById('instrument-name');
        const keywordsInput = document.getElementById('keywords');
        const imageUploadInput = document.getElementById('image-upload');
        const editInstrumentTypesBtn = document.getElementById('edit-instrument-types-btn');
        
        const editModeBtn = document.getElementById('edit-mode-btn');
        const editControls = document.getElementById('edit-controls');
        const saveEditBtn = document.getElementById('save-edit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const logoDisplay = document.getElementById('logo-display');
        const totalCountDisplay = document.getElementById('total-count-display');
        const lastUpdatedDisplay = document.getElementById('last-updated-display');
        const filterButtonsContainer = document.getElementById('filter-buttons-container');
        const mapElement = document.getElementById('map');
        const messageModal = document.getElementById('message-modal');
        const messageText = document.getElementById('message-text');
        const passwordModal = document.getElementById('password-modal');
        const passwordCloseBtn = document.getElementById('password-close-btn');
        const passwordInput = document.getElementById('password-input');
        const passwordSubmitBtn = document.getElementById('password-submit-btn');
        const yearFilter = document.getElementById('year-filter');
        const monthFilter = document.getElementById('month-filter');
        const detailsContainer = document.getElementById('details-table-content');
        const exportStandaloneBtn = document.getElementById('export-standalone-btn');

        const collapsibleControls = document.getElementById('collapsible-controls');

        const langZhBtn = document.getElementById('lang-zh-btn');
        const langEnBtn = document.getElementById('lang-en-btn');

        // New dashboard elements
        const viewToggleBtn = document.getElementById('view-toggle-btn');
        const detailsViewTitle = document.getElementById('details-view-title');
        const detailsTableContent = document.getElementById('details-table-content');
        const dashboardContent = document.getElementById('dashboard-content');
        const dashboardChartContainer = document.getElementById('dashboard-chart-container');

        let editingInstrument = null;

        // --- Utility Functions ---
        
        // 更改：新增下载函数，用于管理员保存数据
        function downloadJSON(data, filename) {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", filename);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function setLanguage(newLang) {
            lang = newLang;
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    const value = translations[lang][key];
                    if (typeof value === 'function') {
                        // For elements with dynamic content, we let the specific function handle it.
                    } else {
                        element.textContent = value;
                    }
                }
            });
            populateDateFilters(); // Update dropdown options with correct language
            handleFilterChanges(); // Re-render the UI
        }

        function showMessage(messageKey, ...args) {
            let message = translations[lang][messageKey];
            if (typeof message === 'function') {
                message = message(...args);
            }
            messageText.innerHTML = message.replace(/\n/g, '<br>');
            messageModal.style.display = 'flex';
            setTimeout(() => {
                messageModal.style.display = 'none';
            }, 8000); // 更改：消息显示时间延长，以确保管理员看到上传提示
        }

        async function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => resolve(event.target.result);
                reader.onerror = (e) => reject('messageFileFailed');
                reader.readAsDataURL(file);
            });
        }
        
        async function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => resolve(event.target.result);
                reader.onerror = (e) => reject('messageFileFailed');
                reader.readAsText(file);
            });
        }

        async function handleGeoJSONUpload(file) {
            if (!file) return;
            try {
                const text = await readFileAsText(file);
                state.geojsonData = JSON.parse(text);
                // 更改：不再保存到 IndexedDB，而是提示下载
                downloadJSON(state.geojsonData, DATA_FILES.geojson);
                showMessage('messageGeojsonSuccess');
            } catch (e) {
                showMessage('messageGeojsonError');
                console.error(e);
            }
        }

        async function handleCSVUpload(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    reject('messageFileRequired');
                    return;
                }
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    transformHeader: (header) => {
                        const trimmedHeader = header.trim().toLowerCase();
                        if (trimmedHeader.includes('日期') || trimmedHeader.includes('date')) return '日期时间';
                        if (trimmedHeader.includes('省份') || trimmedHeader.includes('province') || trimmedHeader.includes('省')) return '省份拼音';
                        if (trimmedHeader.includes('产品') || trimmedHeader.includes('信息') || trimmedHeader.includes('描述') || trimmedHeader.includes('product') || trimmedHeader.includes('info')) return '产品信息';
                        if (trimmedHeader.includes('医院') || trimmedHeader.includes('hospital')) return '医院';
                        if (trimmedHeader.includes('安装') || trimmedHeader.includes('installed')) return '安装信息';
                        return header;
                    },
                    complete: async (results) => {
                        const columns = results.meta.fields;
                        console.log("Parsed CSV headers:", columns); // For debugging purposes
                        const missingCols = expectedDataColumns.filter(col => !columns.includes(col));
                        if (missingCols.length > 0) {
                            reject(translations[lang]['messageCsvMissingCols'](missingCols.join(', ')));
                            return;
                        }

                        state.allData = results.data.map(row => {
                            const dateTime = row['日期时间'];
                            if (dateTime) {
                                const [date, time] = dateTime.split(' ');
                                row['日期'] = date || '';
                                row['时间'] = time || '';
                            }
                            return row;
                        });
                        
                        // 更改：不再保存到 IndexedDB
                        const now = new Date().toISOString();
                        state.lastUpdated = now;
                        
                        // 提示管理员下载并上传文件
                        downloadJSON(state.allData, DATA_FILES.data);
                        downloadJSON({ lastUpdated: now }, DATA_FILES.updated);
                        
                        updateLastUpdatedDisplay();
                        resolve("messageCsvSuccess");
                    },
                    error: (error) => {
                        reject('messageCsvError');
                        console.error('CSV Parsing Error:', error);
                    }
                });
            });
        }
        
        async function updateLastUpdatedDisplay() {
            // 更改：直接使用 state 中的值
            const lastUpdated = state.lastUpdated; 
            lastUpdatedDisplay.textContent = translations[lang]['lastUpdated'](lastUpdated);
        }

        function populateDateFilters() {
            // ... (此函数保持不变，因为它只读取 state.allData)
            const years = new Set(['所有年份']);
            const months = new Set(['所有月份']);
            state.allData.forEach(row => {
                const date = new Date(row['日期时间']);
                if (!isNaN(date.getTime())) {
                    years.add(date.getFullYear().toString());
                    months.add((date.getMonth() + 1).toString().padStart(2, '0'));
                }
            });

            const sortedYears = Array.from(years).sort().reverse();
            yearFilter.innerHTML = sortedYears.map(y => `<option value="${y}">${y}</option>`).join('');

            const sortedMonths = Array.from(months).sort();
            monthFilter.innerHTML = sortedMonths.map(m => `<option value="${m}">${m}</option>`).join('');
            
            // Re-translate the filter options based on current language
            const allYearsOption = yearFilter.querySelector('option[value="所有年份"]');
            if (allYearsOption) {
                allYearsOption.textContent = translations[lang]['selectYear'].includes('年') ? '所有年份' : 'All Years';
                yearFilter.value = '所有年份'; // Default to Chinese value
            }
            
            const allMonthsOption = monthFilter.querySelector('option[value="所有月份"]');
            if (allMonthsOption) {
                allMonthsOption.textContent = translations[lang]['selectMonth'].includes('月') ? '所有月份' : 'All Months';
                monthFilter.value = '所有月份'; // Default to Chinese value
            }
        }
        
        function getFilteredData() {
            // ... (此函数保持不变)
            const selectedInstrument = document.querySelector('.filter-button.active')?.dataset.name;
            const selectedYear = yearFilter.value;
            const selectedMonth = monthFilter.value;

            let filteredData = state.allData;

            if (selectedYear !== '所有年份') {
                filteredData = filteredData.filter(row => {
                    const date = new Date(row['日期时间']);
                    return !isNaN(date.getTime()) && date.getFullYear().toString() === selectedYear;
                });
            }
            if (selectedMonth !== '所有月份') {
                filteredData = filteredData.filter(row => {
                    const date = new Date(row['日期时间']);
                    return !isNaN(date.getTime()) && (date.getMonth() + 1).toString().padStart(2, '0') === selectedMonth;
                });
            }

            if (selectedInstrument !== 'all') {
                const definition = state.instrumentDefinitions.find(def => def.name === selectedInstrument);
                if (definition) {
                    const keywords = definition.keywords.map(k => k.toLowerCase().trim());
                    filteredData = filteredData.filter(row => {
                        const productInfo = row['产品信息']?.toLowerCase()?.trim() || '';
                        return keywords.some(keyword => productInfo.includes(keyword));
                    });
                }
            }
            // Apply province filter if selected
            if (selectedProvincePinyin) {
                 filteredData = filteredData.filter(row => row['省份拼音']?.toLowerCase()?.trim() === selectedProvincePinyin);
            }
            return filteredData;
        }

        function renderInstrumentDetails(provincePinyin) {
            // ... (此函数保持不变)
            const filteredData = getFilteredData();
            const provinceData = filteredData.filter(row => row['省份拼音']?.toLowerCase()?.trim() === provincePinyin);
            
            let html = '';
            if (provinceData.length > 0) {
                let provinceName = '';
                geojsonLayer.eachLayer(layer => {
                    if (layer.feature.properties.pinyin?.toLowerCase().trim() === provincePinyin) {
                        provinceName = (lang === 'en' ? layer.feature.properties.pinyin : layer.feature.properties.name);
                    }
                });
                
                html = `<h3 class="font-bold text-lg mb-2">${translations[lang]['detailsTableTitle'](provinceName, provinceData.length)}</h3>`;
                
                html += `<div class="bg-gray-700 p-4 rounded-lg overflow-x-auto">
                            <table class="details-table">
                                <thead>
                                    <tr>
                                        <th>${translations[lang]['tableHeaderDate']}</th>
                                        <th>${translations[lang]['tableHeaderHospital']}</th>
                                        <th>${translations[lang]['tableHeaderProduct']}</th>
                                        <th>${translations[lang]['tableHeaderInstallInfo']}</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                provinceData.forEach(row => {
                    html += `<tr>
                                    <td>${row['日期'] || 'N/A'}</td>
                                    <td>${row['医院'] || 'N/A'}</td>
                                    <td>${row['产品信息'] || 'N/A'}</td>
                                    <td>${row['安装信息'] || 'N/A'}</td>
                               </tr>`;
                });
                html += `</tbody></table></div>`;
            } else {
                html = `<div class="p-4 text-center">${translations[lang]['detailsPlaceholder']}</div>`;
            }
            detailsContainer.innerHTML = html;
        }

        function getInstallationDataByDate() {
            // ... (此函数保持不变)
            const filteredData = getFilteredData();
            const selectedYear = yearFilter.value;
            const selectedMonth = monthFilter.value;
            const isYearlyView = selectedYear === '所有年份';
            const isMonthlyView = selectedMonth === '所有月份';
            
            const counts = {};

            if (isYearlyView) {
                // All years view
                const allYears = Array.from(new Set(state.allData.map(d => new Date(d['日期时间']).getFullYear()))).filter(y => !isNaN(y)).sort();
                filteredData.forEach(row => {
                    const date = new Date(row['日期时间']);
                    if (!isNaN(date.getTime())) {
                        const year = date.getFullYear().toString();
                        counts[year] = (counts[year] || 0) + 1;
                    }
                });
                return allYears.map(year => ({
                    date: d3.timeParse('%Y')(year),
                    count: counts[year] || 0
                }));

            } else if (isMonthlyView) {
                // Specific year, all months
                filteredData.forEach(row => {
                    const date = new Date(row['日期时间']);
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    counts[month] = (counts[month] || 0) + 1;
                });
                
                const data = [];
                for (let i = 1; i <= 12; i++) {
                    const monthStr = String(i).padStart(2, '0');
                    const date = new Date(selectedYear, i-1, 1);
                    data.push({
                        date: date,
                        count: counts[monthStr] || 0
                    });
                }
                return data;

            } else {
                // Specific year and month, all days
                filteredData.forEach(row => {
                    const date = new Date(row['日期时间']);
                    const day = String(date.getDate()).padStart(2, '0');
                    counts[day] = (counts[day] || 0) + 1;
                });

                const data = [];
                const daysInMonth = new Date(selectedYear, selectedMonth, 0).getDate();
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayStr = String(i).padStart(2, '0');
                    const date = new Date(selectedYear, selectedMonth - 1, i);
                    data.push({
                        date: date,
                        count: counts[dayStr] || 0
                    });
                }
                return data;
            }
        }

        function renderDashboardChart() {
            // ... (此函数保持不变)
            const data = getInstallationDataByDate();
            dashboardChartContainer.innerHTML = '';
            
            if (data.length === 0) {
                dashboardChartContainer.innerHTML = `<div class="p-4 text-center text-gray-400">${translations[lang]['noDataMessage']}</div>`;
                return;
            }

            const margin = {top: 40, right: 30, bottom: 40, left: 50},
                width = dashboardContent.clientWidth - margin.left - margin.right,
                height = dashboardChartContainer.clientHeight - margin.top - margin.bottom;

            const svg = d3.select(dashboardChartContainer)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleTime()
                .domain(d3.extent(data, d => d.date))
                .range([0, width]);
            
            const selectedYear = yearFilter.value;
            const selectedMonth = monthFilter.value;
            let xTicks, xFormat;
            
            if (selectedYear === '所有年份') {
                xTicks = d3.timeYear.every(1);
                xFormat = d3.timeFormat('%Y');
            } else if (selectedMonth !== '所有月份') {
                xTicks = d3.timeDay.every(1);
                xFormat = d3.timeFormat('%d');
            } else {
                xTicks = d3.timeMonth.every(1);
                xFormat = d3.timeFormat('%m');
            }

            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x)
                    .ticks(xTicks)
                    .tickFormat(xFormat)
                )
                .selectAll('text')
                .attr('fill', '#9ca3af')
                .style('text-anchor', 'end')
                .attr('transform', 'rotate(-45)');

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.count)])
                .range([height, 0]);
            svg.append('g')
                .call(d3.axisLeft(y).ticks(Math.min(5, d3.max(data, d => d.count))))
                .selectAll('text')
                .attr('fill', '#9ca3af');

            svg.append('path')
                .datum(data)
                .attr('fill', 'none')
                .attr('stroke', '#4299e1')
                .attr('stroke-width', 2.5)
                .attr('d', d3.line()
                    .x(d => x(d.date))
                    .y(d => y(d.count))
                );

            const points = svg.selectAll('.dot')
                .data(data)
                .enter().append('g')
                .attr('class', 'dot-group')
                .attr('transform', d => `translate(${x(d.date)}, ${y(d.count)})`);

            points.append('circle')
                .attr('r', 5)
                .attr('fill', '#4299e1');

            points.append('text')
                .attr('dx', '-0.5em')
                .attr('dy', '-1em')
                .attr('font-size', '12px')
                .attr('fill', '#fff')
                .attr('text-anchor', 'end')
                .text(d => d.count);
        }

        // --- Map Initialization & Rendering Logic (保持不变) ---
        function initMap() {
            if (map && map.getContainer()) {
                map.remove();
            }
            map = L.map('map', {
                center: [35.8617, 104.1954],
                zoom: 4,
                zoomControl: false,
                minZoom: 4,
                maxZoom: 6,
                attributionControl: false
            });

            L.rectangle([[-90, -180], [90, 180]], {
                color: '#000', weight: 1, fillColor: '#000', fillOpacity: 1
            }).addTo(map);

            markerGroup = L.layerGroup().addTo(map);

            // Invalidate size to fix rendering issues
            map.invalidateSize();
        }

        function renderMap(filteredData, isEditable = false) {
            // ... (此函数保持不变，它只依赖 state 变量)
            if (geojsonLayer